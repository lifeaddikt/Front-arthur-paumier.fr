import React from 'react'
import { useRouter } from 'next/router'
import Head from 'next/head'
import PropTypes from 'prop-types'
import Grid from '../../components/Grid/Grid'
import collectionService from '../../services/collectionService'
import pictureService from '../../services/pictureService'
import { getPlaiceholder } from 'plaiceholder'
import Layout from '../../components/Layout/Layout.jsx'

const Collection = ({ pictures, description }) => {
  const router = useRouter()
  const { slug } = router.query
  const capitalizedSlug = slug?.charAt(0)?.toUpperCase() + slug?.slice(1)

  const title = `${process.env.NEXT_PUBLIC_APP_TITLE} | ${capitalizedSlug}`

  return (
    <>
      <Head>
        <title key='title'>{title}</title>
        <meta
          key='description'
          name='description'
          content='Generated by create next app'
        />
      </Head>
      <Layout description={description}>
        <Grid pictures={pictures} />
      </Layout>
    </>
  )
}

export async function getStaticPaths() {
  const collections = await collectionService.loadAllCollections()
  const paths = collections.map(collection => ({
    params: { slug: collection.slug },
  }))
  return {
    paths,
    fallback: 'blocking',
  }
}

export async function getStaticProps({ params }) {
  const pictures = await pictureService.loadPicturesByCollection(params.slug)
  const collection = await collectionService.loadCollection(params.slug)

  const picturesWithBase64 = await Promise.all(pictures.map(async picture => {
    const { base64 } = await getPlaiceholder(picture._embedded['wp:featuredmedia'][0].media_details.sizes.full.source_url)
    picture.base64 = base64
    return picture
  }))

  picturesWithBase64.sort((a, b) => {
    const priorityA = a.acf.priority !== undefined ? parseInt(a.acf.priority) : 999
    const priorityB = b.acf.priority !== undefined ? parseInt(b.acf.priority) : 999

    return priorityA - priorityB
  })

  return {
    props: {
      pictures: picturesWithBase64,
      description: collection[0].description,
    },
    revalidate: 10,
  }
}

Collection.propTypes = {
  pictures: PropTypes.array.isRequired,
  description: PropTypes.string.isRequired,
}

export default Collection
